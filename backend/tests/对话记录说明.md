# Mac Agent 对话记录说明

> **文档日期**: 2026-01-29  
> **功能**: 完整的对话记录保存和查看

---

## 📋 概述

Mac Agent 测试系统现在支持两种测试模式：

### 1. 工具直接测试（原有功能）

**文件**: `tests/run_tool_tests.py`

**功能**: 直接测试工具的执行，记录工具的入参和出参

**保存位置**: `tests/test_results/`
- `test_results_*.json` - JSON格式
- `test_report_*.md` - Markdown格式

**查看方式**:
```bash
python tests/view_results.py
```

### 2. 对话测试（新增功能）⭐

**文件**: `tests/run_chat_tests.py`

**功能**: 通过MacAgent进行完整对话，记录：
- 👤 用户输入的问题
- 🤖 Agent的完整响应
- 🔧 Agent调用的所有工具
- 📝 工具调用的参数和结果
- ⏰ 时间戳

**保存位置**: `tests/chat_logs/`
- `chat_logs_*.json` - JSON格式（完整对话记录）
- `chat_report_*.md` - Markdown格式（人类可读）

**查看方式**:
```bash
python tests/view_chat_logs.py
```

---

## 🚀 快速开始

### 运行对话测试

```bash
cd /Users/xinfuzhang/Desktop/Code/mac_agent/backend
source .venv/bin/activate
python tests/run_chat_tests.py
```

### 查看对话记录

#### 方式1: 交互式查看器

```bash
python tests/view_chat_logs.py
```

**功能菜单**:
```
1. 查看对话摘要
2. 查看对话列表
3. 查看失败的对话
4. 查看成功的对话
5. 按编号查看对话详情
6. 查看所有对话详情
0. 退出
```

#### 方式2: 命令行快速查看

```bash
# 查看摘要
python tests/view_chat_logs.py summary

# 查看对话列表
python tests/view_chat_logs.py list

# 查看失败的对话
python tests/view_chat_logs.py failed

# 查看所有对话详情
python tests/view_chat_logs.py all
```

#### 方式3: 直接查看文件

```bash
# 查看最新的Markdown报告
open tests/chat_logs/chat_report_*.md

# 查看JSON数据（需要jq）
cat tests/chat_logs/chat_logs_*.json | jq
```

---

## 📁 文件位置

### 对话记录文件

```
backend/tests/chat_logs/
├── chat_logs_20260129_191951.json    # JSON格式（完整数据）
└── chat_report_20260129_191951.md    # Markdown格式（人类可读）
```

### 工具测试结果文件

```
backend/tests/test_results/
├── test_results_20260129_191951.json    # JSON格式（工具测试）
└── test_report_20260129_191951.md        # Markdown格式（工具测试）
```

---

## 📊 对话记录格式

### JSON格式示例

```json
{
  "timestamp": "20260129_191951",
  "total_conversations": 5,
  "successful": 5,
  "failed": 0,
  "conversations": [
    {
      "user_input": "查看系统信息",
      "description": "测试系统信息工具调用",
      "timestamp": "2026-01-29T19:19:51.414045",
      "events": [
        {
          "type": "tool_start",
          "tool_name": "system_info",
          "tool_args": {},
          "timestamp": "2026-01-29T19:19:51.415000"
        },
        {
          "type": "tool_result",
          "tool_result": {
            "ok": true,
            "data": { ... }
          },
          "timestamp": "2026-01-29T19:19:51.420000"
        },
        {
          "type": "content",
          "content": "根据系统信息...",
          "timestamp": "2026-01-29T19:19:51.425000"
        }
      ],
      "tool_calls": [
        {
          "name": "system_info",
          "args": {},
          "result": {
            "ok": true,
            "data": { ... }
          },
          "timestamp": "2026-01-29T19:19:51.415000"
        }
      ],
      "agent_response": "根据系统信息，您的macOS版本是...",
      "success": true,
      "error": null
    }
  ]
}
```

### Markdown格式示例

```markdown
# Mac Agent 对话测试报告

> **测试时间**: 2026-01-29 19:19:51
> **对话总数**: 5
> **成功**: 5 ✅
> **失败**: 0 ❌

## 💬 详细对话记录

### 1. 对话 1 - ✅ 成功

**描述**: 测试系统信息工具调用

**👤 用户输入**:

```
查看系统信息
```

**🤖 Agent响应**:

```
根据系统信息，您的macOS版本是...
```

**🔧 工具调用** (1 个):

#### 1. system_info

**参数**:
```json
{}
```

**结果**:
```json
{
  "ok": true,
  "data": { ... }
}
```

**⏰ 时间**: 2026-01-29T19:19:51.414045
```

---

## 🔍 对比两种测试模式

| 特性 | 工具直接测试 | 对话测试 |
|------|------------|---------|
| **测试方式** | 直接调用工具 | 通过Agent对话 |
| **记录内容** | 工具入参、出参 | 用户输入、Agent响应、工具调用 |
| **使用场景** | 工具功能验证 | 端到端对话流程 |
| **文件位置** | `test_results/` | `chat_logs/` |
| **查看工具** | `view_results.py` | `view_chat_logs.py` |

---

## 💡 使用建议

### 何时使用工具直接测试

- ✅ 快速验证工具功能
- ✅ 测试工具的参数和返回值
- ✅ 不需要Agent推理过程
- ✅ 批量测试所有工具

### 何时使用对话测试

- ✅ 测试完整的对话流程
- ✅ 验证Agent如何选择和使用工具
- ✅ 查看Agent的推理过程
- ✅ 测试自然语言交互

---

## 📚 相关文档

- **工具测试使用指南**: `tests/测试使用指南.md`
- **完整测试报告**: `docs/工具测试完整报告_20260129.md`
- **交付总结**: `docs/测试系统交付总结_20260129.md`

---

## 🎯 快速参考

### 运行测试

```bash
# 工具直接测试
python tests/run_tool_tests.py

# 对话测试
python tests/run_chat_tests.py
```

### 查看结果

```bash
# 查看工具测试结果
python tests/view_results.py summary

# 查看对话记录
python tests/view_chat_logs.py summary
```

### 文件位置

```bash
# 工具测试结果
ls -lh tests/test_results/

# 对话记录
ls -lh tests/chat_logs/
```

---

**最后更新**: 2026-01-29  
**版本**: 1.0
